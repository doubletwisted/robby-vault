<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Neural Weaver - Robby Freestyle</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300&display=swap');
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Space Grotesk', sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #hud {
            position: fixed;
            top: 40px;
            left: 40px;
            color: rgba(255, 255, 255, 0.4);
            letter-spacing: 0.5em;
            text-transform: uppercase;
            font-size: 8px;
            pointer-events: none;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            padding-left: 20px;
            mix-blend-mode: difference;
        }
        #debug { position: fixed; top: 10px; right: 10px; color: #0f0; font-size: 9px; pointer-events: none; }
    </style>
</head>
<body>
    <div id="hud">
        Experiment 14 // The Neural Weaver<br>
        Algorithm: Recursive Domain Warp<br>
        State: SYNTHESIZING
    </div>
    <div id="debug"></div>
    <canvas id="glCanvas"></canvas>
    <script>
        const debug = document.getElementById('debug');
        function log(msg) { debug.innerText += msg + '\n'; }
        window.onerror = (e) => log('Error: ' + e);

        const canvas = document.getElementById('glCanvas');
        const gl = canvas.getContext('webgl2', { antialias: false });

        // Hard fail instead of silent white/blank screens
        if(!gl){
            const warn = document.createElement('div');
            warn.style.cssText = 'position:fixed;inset:0;background:#000;color:#e6e6e6;z-index:9999;padding:20px;font:14px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;';
            warn.innerHTML = '<div style="max-width:820px"><div style="color:#ff4d4d;letter-spacing:.2em;text-transform:uppercase;font-size:12px">WebGL2 required</div><h1 style="margin:10px 0 8px 0;font-size:18px">The Neural Weaver needs WebGL2.</h1><div style="opacity:.8">On iPhone Safari / older browsers this can be unsupported. Try Chrome/Edge on desktop, or update iOS.</div></div>';
            document.body.appendChild(warn);
            log('WebGL2 not available');
            throw new Error('WebGL2 not available');
        }

        const vs = `#version 300 es
            void main() {
                gl_Position = vec4(vec2((gl_VertexID << 1) & 2, gl_VertexID & 2) * 2.0 - 1.0, 0.0, 1.0);
            }
        `;

        const fsMain = `#version 300 es
        precision highp float;
        out vec4 fragColor;
        uniform vec2 u_res;
        uniform float u_time;
        uniform vec2 u_mouse;
        uniform sampler2D u_prev;

        mat2 rot(float a) { return mat2(cos(a), -sin(a), sin(a), cos(a)); }
        float hash(vec2 p) { return fract(sin(dot(p, vec2(12.9898, 78.233))) * 43758.5453); }
        float noise(vec2 p) {
            vec2 i = floor(p); vec2 f = fract(p);
            f = f*f*(3.0-2.0*f);
            return mix(mix(hash(i), hash(i+vec2(1,0)), f.x), mix(hash(i+vec2(0,1)), hash(i+vec2(1,1)), f.x), f.y);
        }
        float fbm(vec2 p) {
            float v = 0.0; float a = 0.5;
            for (int i = 0; i < 6; i++) { v += a * noise(p); p = rot(0.5) * p * 2.1; a *= 0.5; }
            return v;
        }

        void main() {
            vec2 uv = gl_FragCoord.xy / u_res;
            vec2 p = (uv * 2.0 - 1.0) * vec2(u_res.x/u_res.y, 1.0);
            vec2 m = (u_mouse / u_res * 2.0 - 1.0) * vec2(u_res.x/u_res.y, 1.0);
            float dist = length(p - m);
            float brush = smoothstep(0.4, 0.0, dist) * 0.15;
            vec2 warp = vec2(fbm(p + u_time * 0.1), fbm(p + vec2(1.2)));
            vec2 prevUV = uv + warp * 0.002 * (1.0 + brush * 10.0);
            vec4 prev = texture(u_prev, prevUV);
            float pattern = fbm(p * 2.0 + warp * 0.5);
            vec3 newSignal = vec3(0.1, 0.3, 0.6) * pattern * brush;
            newSignal += vec3(0.8, 0.4, 0.2) * smoothstep(0.1, 0.0, dist) * 0.5;
            vec3 color = mix(prev.rgb, newSignal, 0.1) * 0.98;
            vec3 graded = mix(vec3(0.01, 0.02, 0.05), vec3(0.8, 0.9, 1.0), color.r);
            graded = mix(graded, vec3(1.0, 0.3, 0.2), color.g * 0.5) + color * 1.5;
            fragColor = vec4(graded, 1.0);
        }
        `;

        function createShader(gl, type, source) {
            const s = gl.createShader(type); gl.shaderSource(s, source); gl.compileShader(s);
            if (!gl.getShaderParameter(s, gl.COMPILE_STATUS)) log('Shader error: ' + gl.getShaderInfoLog(s));
            return s;
        }

        const program = gl.createProgram();
        gl.attachShader(program, createShader(gl, gl.VERTEX_SHADER, vs));
        gl.attachShader(program, createShader(gl, gl.FRAGMENT_SHADER, fsMain));
        gl.linkProgram(program);
        if(!gl.getProgramParameter(program, gl.LINK_STATUS)) log('Link error: ' + gl.getProgramInfoLog(program));

        const textures = [gl.createTexture(), gl.createTexture()];
        const fbos = [gl.createFramebuffer(), gl.createFramebuffer()];

        function initFBO(idx, w, h) {
            gl.bindTexture(gl.TEXTURE_2D, textures[idx]);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, w, h, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.bindFramebuffer(gl.FRAMEBUFFER, fbos[idx]);
            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, textures[idx], 0);

            const status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);
            if(status !== gl.FRAMEBUFFER_COMPLETE){
                log('FBO incomplete: ' + status);
                throw new Error('FBO incomplete: ' + status);
            }
        }

        const uRes = gl.getUniformLocation(program, 'u_res');
        const uTime = gl.getUniformLocation(program, 'u_time');
        const uMouse = gl.getUniformLocation(program, 'u_mouse');
        const uPrev = gl.getUniformLocation(program, 'u_prev');

        let current = 0, mx = 0, my = 0;
        window.addEventListener('mousemove', e => { mx = e.clientX; my = window.innerHeight - e.clientY; });
        window.addEventListener('touchmove', e => { mx = e.touches[0].clientX; my = window.innerHeight - e.touches[0].clientY; });

        function render(t) {
            const w = window.innerWidth, h = window.innerHeight;
            if (canvas.width !== w || canvas.height !== h) {
                canvas.width = w; canvas.height = h;
                initFBO(0, w, h); initFBO(1, w, h);
            }
            gl.useProgram(program);
            gl.uniform2f(uRes, w, h);
            gl.uniform1f(uTime, t * 0.001);
            gl.uniform2f(uMouse, mx, my);
            gl.activeTexture(gl.TEXTURE0);
            gl.bindTexture(gl.TEXTURE_2D, textures[1 - current]);
            gl.uniform1i(uPrev, 0);
            gl.viewport(0, 0, w, h);
            gl.bindFramebuffer(gl.FRAMEBUFFER, fbos[current]);
            gl.drawArrays(gl.TRIANGLES, 0, 3);
            gl.bindFramebuffer(gl.FRAMEBUFFER, null);
            gl.drawArrays(gl.TRIANGLES, 0, 3);
            current = 1 - current;
            requestAnimationFrame(render);
        }
        log('Init neural weaver...');
        requestAnimationFrame(render);
    </script>
</body>
</html>
